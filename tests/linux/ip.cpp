#include <gtest/gtest.h>

#include "protocol/ipv4.hpp"

class Ipv4Test : public ::testing::Test {
public:
    Ipv4Test() : packet_1{space_tcp::Ipv4Packet::create_unchecked(packet_1_data, sizeof(packet_1_data))} {}

protected:
    space_tcp::Ipv4Packet packet_1;

    uint8_t packet_1_data[195] = {
            0x45, 0x00, 0x00, 0xc3, 0x72, 0xdb, 0x40, 0x00,
            0x01, 0x11, 0xff, 0x53, 0x0a, 0x00, 0x0d, 0x01,
            0xef, 0xff, 0xff, 0xfa, 0xe8, 0x9d, 0x07, 0x6c,
            0x00, 0xaf, 0xe3, 0x5f, 0x4d, 0x2d, 0x53, 0x45,
            0x41, 0x52, 0x43, 0x48, 0x20, 0x2a, 0x20, 0x48,
            0x54, 0x54, 0x50, 0x2f, 0x31, 0x2e, 0x31, 0x0d,
            0x0a, 0x48, 0x4f, 0x53, 0x54, 0x3a, 0x20, 0x32,
            0x33, 0x39, 0x2e, 0x32, 0x35, 0x35, 0x2e, 0x32,
            0x35, 0x35, 0x2e, 0x32, 0x35, 0x30, 0x3a, 0x31,
            0x39, 0x30, 0x30, 0x0d, 0x0a, 0x4d, 0x41, 0x4e,
            0x3a, 0x20, 0x22, 0x73, 0x73, 0x64, 0x70, 0x3a,
            0x64, 0x69, 0x73, 0x63, 0x6f, 0x76, 0x65, 0x72,
            0x22, 0x0d, 0x0a, 0x4d, 0x58, 0x3a, 0x20, 0x31,
            0x0d, 0x0a, 0x53, 0x54, 0x3a, 0x20, 0x75, 0x72,
            0x6e, 0x3a, 0x64, 0x69, 0x61, 0x6c, 0x2d, 0x6d,
            0x75, 0x6c, 0x74, 0x69, 0x73, 0x63, 0x72, 0x65,
            0x65, 0x6e, 0x2d, 0x6f, 0x72, 0x67, 0x3a, 0x73,
            0x65, 0x72, 0x76, 0x69, 0x63, 0x65, 0x3a, 0x64,
            0x69, 0x61, 0x6c, 0x3a, 0x31, 0x0d, 0x0a, 0x55,
            0x53, 0x45, 0x52, 0x2d, 0x41, 0x47, 0x45, 0x4e,
            0x54, 0x3a, 0x20, 0x43, 0x68, 0x72, 0x6f, 0x6d,
            0x69, 0x75, 0x6d, 0x2f, 0x38, 0x39, 0x2e, 0x30,
            0x2e, 0x34, 0x33, 0x38, 0x39, 0x2e, 0x31, 0x32,
            0x38, 0x20, 0x4c, 0x69, 0x6e, 0x75, 0x78, 0x0d,
            0x0a, 0x0d, 0x0a
    };
};

TEST_F(Ipv4Test, Version) {
    EXPECT_EQ(4, packet_1.version());
}

TEST_F(Ipv4Test, IHL) {
    EXPECT_EQ(5, packet_1.ihl());
}

TEST_F(Ipv4Test, DSCP) {
    EXPECT_EQ(0, packet_1.dscp());
}

TEST_F(Ipv4Test, ECN) {
    EXPECT_EQ(0, packet_1.ecn());
}

TEST_F(Ipv4Test, TotalLength) {
    EXPECT_EQ(195, packet_1.length());
}

TEST_F(Ipv4Test, Identification) {
    EXPECT_EQ(0x72db, packet_1.identification());
}

TEST_F(Ipv4Test, Flags) {
    EXPECT_EQ(0x02, packet_1.flags());
}

TEST_F(Ipv4Test, FragmentOffset) {
    EXPECT_EQ(0, packet_1.fragment_offset());
}

TEST_F(Ipv4Test, TTL) {
    EXPECT_EQ(0x01, packet_1.ttl());
}

TEST_F(Ipv4Test, Protocol) {
    EXPECT_EQ(0x11, packet_1.protocol());
}

TEST_F(Ipv4Test, Checksum) {
    EXPECT_EQ(0xff53, packet_1.checksum());
}

TEST_F(Ipv4Test, SourceIP) {
    EXPECT_EQ(0xa000d01, packet_1.source_ip());
}

TEST_F(Ipv4Test, DestinationIP) {
    EXPECT_EQ(0xeffffffa, packet_1.dest_ip());
}

TEST_F(Ipv4Test, Payload) {
    for (int i = 20; i < packet_1.length(); i++) {
        ASSERT_EQ(packet_1_data[i], packet_1.payload()[i - 20]);
    }
}
